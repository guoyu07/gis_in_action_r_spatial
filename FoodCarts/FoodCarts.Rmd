---
title: "Interactive Mapping in R"
author: "Ben Weinstein"
date: "April 10, 2017"
runtime: shiny
output: html_document
---

```{r,echo=F}
library(knitr)
opts_chunk$set(message=F,warning=F)
```

# Sharing Visualizations - Welcome to Shiny.

R is not only a wonderful spatial analysis tool, but a great program for creating interactive maps. This afternoon we will learn how to 

* Load a csv into R

* Plot spatial coordinates on a basemap

* Create an interactive visualization using [shiny](https://shiny.rstudio.com/)

We will discuss, but not cover

* Hosting and sharing interactive visualizations online

# Our Example: Food Carts

Who doesn't love food carts? Portland has over 200 of these tasty establishments. For this workshop I scraped the data from [online](http://www.foodcartsportland.com/maps/) for us to play with. Let's look at the data.

```{r}
foodcarts<-read.csv("FoodCarts.csv")
head(foodcarts)
```

A bit ugly, but it will do!

We have the geographic coordinates, the name, and a html description. The description includes some (slightly jumbled), but awesome information. For some carts we have images, for example.


![The Whole Bowl](http://lh4.googleusercontent.com/proxy/if5r5jLACpgPCBsa57v0DRrI5YzeAbFnJmsME6ZEIbV-qKUv0frhjsPMU9DplNINUXlWSCr-qWLOpsmtG8-vNPvz92h62FmsNM7mohW0-WEA2IM)

The html also has some nice information, such as food type, such as 

```{r,echo=F}
print('<img src="http://lh4.googleusercontent.com/proxy/x4RV6lz3SxhwZrRFCksQqlbieOPWBcv1ugZ0j-RiLCXasRKv4msZOOuHBeYlGnwGIJT-AK_vi4hG_YZJtQqDwEcb2m2MoGA7j3rEHNtpL7M" height="200" width="auto" /><br><br>**Syrian and Mediterranean cusine**<br>http://www.foodcartsportland.com/2007/10/29/aybalaya-mediterranean/"')
```

Which renders to:
<img src="http://lh4.googleusercontent.com/proxy/x4RV6lz3SxhwZrRFCksQqlbieOPWBcv1ugZ0j-RiLCXasRKv4msZOOuHBeYlGnwGIJT-AK_vi4hG_YZJtQqDwEcb2m2MoGA7j3rEHNtpL7M" height="200" width="auto" /><br><br>**Syrian and Mediterranean cusine**<br>http://www.foodcartsportland.com/2007/10/29/aybalaya-mediterranean/ 

Okay, but how to turn all of this into a map?

# Basic Mapping

Our first goal is to tell R that we have spatially explicit data. We will use the library (sp)

```{r}
library(sp)

#coordiantes
coordinates<-cbind(foodcarts$x,foodcarts$y)
head(coordinates)

sp_foodcarts<-SpatialPointsDataFrame(coordinates,data=foodcarts)
```

What did we just do? 

We made a spatially explicit object, each of the rows now has a lat/long based on the object coordinates, and some spatial data, found in the object foodcarts.

Let's make our first plot

```{r}
plot(sp_foodcarts)
```

Okay that's fine, but it doesn't do much for us.

# Interactive Mapping using Leaflet

Let's start making it more interesting. We need a basemap. Here comes [leaflet](https://rstudio.github.io/leaflet/)

```{r}
library(leaflet)

our_map<-leaflet() %>% addTiles() %>% addMarkers(data=sp_foodcarts,lng=~x,lat=~y)

our_map
```

Whoa, a lot happened. Let's break that down.

```{r,eval=F}
?leaflet
```

* leaflet() creates a blank map for us

* addTiles() adds a base map, the extent of this base map comes from the following function

* addMarkers() is going to create points based on our food cart data

What about those data arguments?

The ~ is a way of saying, take the columns from our data. So lng=~x says the longitude information in our data is stored in a column named x.

Back to the map. Those labels are clickable, but nothing happens when select one. Let's change that.

```{r}
our_map<-leaflet() %>% addTiles() %>% addMarkers(data=sp_foodcarts,lng=~x,lat=~y,popup=~Name)

our_map
```

Now when we click the markers, we can see the name of each cart.

Great, we have a reasonable first map, how can we share it with other food cart lovers?

# Sharing maps using Shiny

[Shiny](https://shiny.rstudio.com/) combines the computational power of R with the interactivity of the modern web.

Shiny is a full fledged application platform. We will cover just a taste for our food cart fun.

Let's use the power of rstudio to create a shiny template.

Go to File -> New File -> Shiny Web App

Let's check out what we see

```{r,eval=F}
library(shiny)

# Define server logic required to draw a histogram
shinyServer(function(input, output) {
   
  output$distPlot <- renderPlot({
    
    # generate bins based on input$bins from ui.R
    x    <- faithful[, 2] 
    bins <- seq(min(x), max(x), length.out = input$bins + 1)
    
    # draw the histogram with the specified number of bins
    hist(x, breaks = bins, col = 'darkgray', border = 'white')
    
  })
  
})
```

```{r,eval=F}
# This is the user-interface definition of a Shiny web application.

# Define UI for application that draws a histogram
shinyUI(fluidPage(
  
  # Application title
  titlePanel("Old Faithful Geyser Data"),
  
  # Sidebar with a slider input for number of bins 
  sidebarLayout(
    sidebarPanel(
       sliderInput("bins",
                   "Number of bins:",
                   min = 1,
                   max = 50,
                   value = 30)
    ),
    
    # Show a plot of the generated distribution
    mainPanel(
       plotOutput("distPlot")
    )
  )
))
```

We can think of the server as the code which computes data requests and the UI (User Interface) as code which presents data to the reader.

Let's see what the default looks like


```{r,eval=T}
library(shiny)

# Define server logic required to draw a histogram
shinyApp(
  
# This is the user-interface definition of a Shiny web application.

# Define UI for application that draws a histogram
  ui<-fluidPage(
  
  # Application title
  titlePanel("Old Faithful Geyser Data"),
  
  # Sidebar with a slider input for number of bins 
  sidebarLayout(
    sidebarPanel(
       sliderInput("bins",
                   "Number of bins:",
                   min = 1,
                   max = 50,
                   value = 30)
    ),
    
    # Show a plot of the generated distribution
    mainPanel(
       plotOutput("distPlot")
    )
)),

server <-shinyServer(function(input, output) {
   
  output$distPlot <- renderPlot({
    
    x    <- faithful[, 2] 
    bins <- seq(min(x), max(x), length.out = input$bins + 1)
    
    # draw the histogram with the specified number of bins
    hist(x, breaks = bins, col = 'darkgray', border = 'white')
    
  })
  
})
)
```

We have already done some of the server side analysis, so let's put that right in there.

```{r,eval=T}
library(shiny)

# Define server logic required to draw a histogram
shinyApp(
  
# This is the user-interface definition of a Shiny web application.

# Define UI for application that draws a histogram
  ui<-fluidPage(
  
# Application title
  titlePanel("Portland Food Carts"),
  
  # Sidebar with a slider input for number of bins 
  leafletOutput("mymap")),

server <-shinyServer(function(input, output) {
   
  output$distPlot <- renderPlot({
    
  our_map<-leaflet() %>% addTiles() %>% addMarkers(data=sp_foodcarts,lng=~x,lat=~y,popup=~Name)

  })
  
  output$mymap <- renderLeaflet(our_map)
}), 
  options = list(height = 500)

)
```

Let's make use of the those html tags we talked about at the top.

Change popup=~Name to popup=~Description - this was the name of the column with the scrapped html information

```{r}
```{r,eval=T}
library(shiny)

# Define server logic required to draw a histogram
shinyApp(
  
# This is the user-interface definition of a Shiny web application.

# Define UI for application that draws a histogram
  ui<-fluidPage(
  
# Application title
  titlePanel("Portland Food Carts"),
  
  # Sidebar with a slider input for number of bins 
  leafletOutput("mymap")),

server <-shinyServer(function(input, output) {
   
  output$distPlot <- renderPlot({
    
  our_map<-leaflet() %>% addTiles() %>% addMarkers(data=sp_foodcarts,lng=~x,lat=~y,popup=~Description)

  })
  
  output$mymap <- renderLeaflet(our_map)
}), 
  options = list(height = 500)

)
```
